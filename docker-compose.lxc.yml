version: '3.8'

# LXC-specific Docker Compose v2 configuration
# Use: docker compose -f docker-compose.lxc.yml up -d
# Key differences from local v1:
# 1. Explicit network definition for better LXC bridge support
# 2. Service hostname resolution via explicit networks
# 3. Service healthcheck configuration for LXC reliability
# 4. IPv4 address assignment for predictable routing
# 5. Explicit DNS configuration

networks:
  microservices-network:
    driver: bridge
    driver_opts:
      # LXC-specific network configuration
      com.docker.network.driver.mtu: 1500
    ipam:
      config:
        - subnet: 172.20.0.0/16

services:

  # --- Infrastructure Services ---

  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0
    container_name: zookeeper
    networks:
      microservices-network:
        ipv4_address: 172.20.0.10
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    restart: always
    healthcheck:
      test: ["CMD", "echo", "ruok", "|", "nc", "localhost", "2181"]
      interval: 10s
      timeout: 5s
      retries: 3

  kafka:
    image: confluentinc/cp-kafka:7.4.0
    container_name: kafka
    depends_on:
      zookeeper:
        condition: service_healthy
    networks:
      microservices-network:
        ipv4_address: 172.20.0.11
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_LOG4J_LOGGERS: "kafka.controller=INFO,kafka.producer.async.DefaultEventHandler=INFO,state.change.logger=INFO"
    restart: always
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions.sh", "--bootstrap-server", "localhost:9092"]
      interval: 10s
      timeout: 5s
      retries: 3

  consul-server:
    image: hashicorp/consul:latest
    container_name: consul-server
    networks:
      microservices-network:
        ipv4_address: 172.20.0.12
    command: agent -server -ui -node=server-1 -bootstrap-expect=1 -client=0.0.0.0
    ports:
      - "8500:8500"
    environment:
      # Explicit DNS configuration for LXC
      CONSUL_BIND_INTERFACE: eth0
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8500/ui/"]
      interval: 10s
      timeout: 5s
      retries: 3

  read-db:
    image: redis:latest
    container_name: read-db
    networks:
      microservices-network:
        ipv4_address: 172.20.0.13
    restart: always
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  postgres-db:
    image: postgres:15
    container_name: postgres-db
    networks:
      microservices-network:
        ipv4_address: 172.20.0.14
    environment:
      POSTGRES_DB: microservices_db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d microservices_db"]
      interval: 10s
      timeout: 5s
      retries: 3

  mongodb:
    image: mongo:latest
    container_name: mongodb
    networks:
      microservices-network:
        ipv4_address: 172.20.0.15
    environment:
      MONGO_INITDB_ROOT_USERNAME: user
      MONGO_INITDB_ROOT_PASSWORD: password
      MONGO_INITDB_DATABASE: posts_db
    restart: always
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 3

  # --- API Gateway ---

  api-gateway:
    image: traefik:v2.10
    container_name: api-gateway
    networks:
      microservices-network:
        ipv4_address: 172.20.0.20
    command:
      - "--configFile=/etc/traefik/traefik.yml"
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./api_gateway/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./api_gateway/dynamic.yml:/etc/traefik/dynamic.yml:ro
    depends_on:
      - auth-service
      - user-profile-service
      - posts-service
      - feed-generator-service
      - mongodb
      - kafka
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # --- Python Microservices ---

  auth-service:
    build:
      context: ./auth_services
      dockerfile: Dockerfile
      cache_from: []
    container_name: auth-service
    networks:
      microservices-network:
        ipv4_address: 172.20.0.30
    environment:
      CONSUL_HOST: consul-server
      CONSUL_PORT: 8500
      DATABASE_URL: postgresql://user:password@postgres-db:5432/microservices_db
    depends_on:
      postgres-db:
        condition: service_healthy
      consul-server:
        condition: service_healthy
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  user-profile-service:
    build:
      context: ./user-profile-service
      dockerfile: Dockerfile
      cache_from: []
    container_name: user-profile-service
    networks:
      microservices-network:
        ipv4_address: 172.20.0.31
    environment:
      CONSUL_HOST: consul-server
      CONSUL_PORT: 8500
      DATABASE_URL: postgresql://user:password@postgres-db:5432/microservices_db
    depends_on:
      postgres-db:
        condition: service_healthy
      consul-server:
        condition: service_healthy
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  posts-service:
    build:
      context: ./posts-service
      dockerfile: Dockerfile
      cache_from: []
    container_name: posts-service
    networks:
      microservices-network:
        ipv4_address: 172.20.0.32
    environment:
      MONGODB_URL: mongodb://user:password@mongodb:27017
      MONGODB_DB: posts_db
      KAFKA_HOST: kafka:9092
      CONSUL_HOST: consul-server
      CONSUL_PORT: 8500
    depends_on:
      mongodb:
        condition: service_healthy
      kafka:
        condition: service_healthy
      consul-server:
        condition: service_healthy
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  feed-generator-service:
    build:
      context: ./feed-generator-service
      dockerfile: Dockerfile
      cache_from: []
    container_name: feed-generator-service
    networks:
      microservices-network:
        ipv4_address: 172.20.0.33
    environment:
      KAFKA_HOST: kafka:9092
      REDIS_HOST: read-db
      REDIS_PORT: 6379
      REDIS_DB: 0
      CONSUL_HOST: consul-server
      CONSUL_PORT: 8500
    depends_on:
      kafka:
        condition: service_healthy
      read-db:
        condition: service_healthy
      consul-server:
        condition: service_healthy
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
